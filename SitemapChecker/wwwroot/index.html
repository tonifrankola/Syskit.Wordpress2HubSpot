<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>syskit.com migration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background-color: #fafbfc;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #370088;
            padding: 30px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 36, 0.15);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        header button {
            font-weight: 600;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid #370088;
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
        }

        .summary-card.active {
            border-left-width: 6px;
            box-shadow: 0 8px 16px rgba(55, 0, 136, 0.2);
        }

        .summary-card.total {
            border-left-color: #370088;
        }

        .summary-card.ok {
            border-left-color: #00BF4C;
        }

        .summary-card.different {
            border-left-color: #FFA100;
        }

        .summary-card.missing {
            border-left-color: #FA1500;
        }

        .summary-card.redirect {
            border-left-color: #9C27B0;
        }

        .summary-card.chain {
            border-left-color: #FF5164;
        }

        .card-label {
            font-size: 0.8125rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .card-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1a1a1a;
        }

        .card-percentage {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
            font-weight: 500;
        }

        .progress-container {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .progress-bar-wrapper {
            height: 30px;
            background-color: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: #370088;
            transition: width 0.3s ease;
            position: absolute;
            left: 0;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            font-size: 0.875rem;
            min-width: 0;
        }

        .progress-bar-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.875rem;
            z-index: 1;
            white-space: nowrap;
        }

        .progress-bar-wrapper .progress-bar-text.light {
            color: #fff;
        }

        .progress-text {
            margin-top: 10px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.875rem;
        }

        .filters {
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: #fff;
            color: #2c3e50;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #370088;
            color: #370088;
        }

        .filter-btn.active {
            background: #370088;
            color: #fff;
            border-color: #370088;
        }

        .table-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background-color: #000024;
            color: #fff;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            position: relative;
            vertical-align: top;
        }

        th:hover {
            background-color: #1a1a2e;
        }

        th.sortable::after {
            content: ' ↕';
            opacity: 0.3;
            font-size: 0.75rem;
        }

        th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.875rem;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-ok {
            background-color: #E8F9F0;
            color: #00773D;
        }

        .status-different {
            background-color: #FFF4E0;
            color: #CC8400;
        }

        .status-missing {
            background-color: #FFEAE6;
            color: #C41000;
        }

        .status-redirect {
            background-color: #F3E5F5;
            color: #7B1FA2;
        }

        .status-chain {
            background-color: #FFE9EC;
            color: #CC2A3A;
        }

        .comparison-badge {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .comparison-identical {
            background-color: #E8F9F0;
            color: #00773D;
        }

        .comparison-different {
            background-color: #FFF4E0;
            color: #CC8400;
        }

        a {
            color: #370088;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .refresh-btn {
            background: transparent;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.75rem;
            color: #6b7280;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .refresh-btn:hover {
            background: #f3f4f6;
            border-color: #370088;
            color: #370088;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .refresh-btn.refreshing {
            background: #F4EEFF;
            border-color: #370088;
            color: #370088;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 1.125rem;
        }

        .hidden {
            display: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(55, 0, 136, 0.3);
            border-radius: 50%;
            border-top-color: #370088;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .export-btn {
            padding: 8px 16px;
            background: #00BF4C;
            color: white;
            border: 2px solid #00BF4C;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #00a040;
            border-color: #00a040;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>syskit.com migration</h1>
            <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button id="refreshBtn" class="filter-btn" style="background: #fff; color: #370088; border-color: #fff; font-weight: 600;">
                    ↻ Refresh All
                </button>
                <button id="checkNewBtn" class="filter-btn" style="background: #00BF4C; color: #fff; border-color: #00BF4C; font-weight: 600;">
                    + Find New Pages
                </button>
                <button id="clearCacheBtn" class="filter-btn" style="background: rgba(255, 255, 255, 0.2); color: #fff; border-color: rgba(255, 255, 255, 0.3); font-weight: 600;">
                    ✕ Clear Cache
                </button>
                <button id="exportBtn" class="export-btn" style="margin-left: auto;">
                    ↓ Export to CSV
                </button>
                <span id="cacheInfo" style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.9);"></span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="summary-cards" id="summaryCards">
            <div class="summary-card total" data-filter="all">
                <div class="card-label">Total Pages</div>
                <div class="card-value" id="totalCount">0</div>
            </div>
            <div class="summary-card ok" data-filter="OK">
                <div class="card-label">OK</div>
                <div class="card-value" id="okCount">0</div>
                <div class="card-percentage" id="okPercent">0%</div>
            </div>
            <div class="summary-card different" data-filter="Different">
                <div class="card-label">Different</div>
                <div class="card-value" id="differentCount">0</div>
                <div class="card-percentage" id="differentPercent">0%</div>
            </div>
            <div class="summary-card missing" data-filter="Missing">
                <div class="card-label">Missing</div>
                <div class="card-value" id="missingCount">0</div>
                <div class="card-percentage" id="missingPercent">0%</div>
            </div>
            <div class="summary-card redirect" data-filter="Redirect301">
                <div class="card-label">301 Redirect</div>
                <div class="card-value" id="redirectCount">0</div>
                <div class="card-percentage" id="redirectPercent">0%</div>
            </div>
            <div class="summary-card chain" data-filter="Redirect301Chain">
                <div class="card-label">301 Chain</div>
                <div class="card-value" id="chainCount">0</div>
                <div class="card-percentage" id="chainPercent">0%</div>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                <div class="progress-bar-text" id="progressBarText">0%</div>
            </div>
            <div class="progress-text" id="progressText">
                <span class="spinner"></span>Initializing...
            </div>
        </div>

        <div class="filters hidden" id="filters">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
                <input type="text" id="searchInput" placeholder="Search by URL..." 
                    style="flex: 1; min-width: 250px; padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 0.875rem; outline: none; transition: border-color 0.2s;">
                <button id="clearSearchBtn" class="filter-btn" style="background: transparent; border-color: #ddd;">✕ Clear</button>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="OK">OK</button>
                <button class="filter-btn" data-filter="Different">Different</button>
                <button class="filter-btn" data-filter="Missing">Missing</button>
                <button class="filter-btn" data-filter="Redirect301">301 Redirect</button>
                <button class="filter-btn" data-filter="Redirect301Chain">301 Chain</button>
            </div>
        </div>

        <div class="table-container">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="existingPage">Existing Page</th>
                        <th class="sortable" data-column="newPage">New Page</th>
                        <th class="sortable" data-column="status">Status</th>
                        <th class="sortable" data-column="titleComparison">Title</th>
                        <th class="sortable" data-column="ogTitleComparison">og:title</th>
                        <th class="sortable" data-column="lastModified">Original Last Modified</th>
                        <th class="sortable" data-column="checkedAt">Checked At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="8" class="loading-message">
                            <span class="spinner"></span>
                            Loading sitemaps...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const results = [];
        let currentFilter = 'all';
        let searchTerm = '';
        
        const statusMap = {
            0: 'OK',
            1: 'Missing',
            2: 'Redirect301',
            3: 'Redirect301Chain',
            4: 'Different'
        };

        function updateSummary() {
            const summary = {
                total: results.length,
                ok: results.filter(r => r.status === 0).length,
                different: results.filter(r => r.status === 4).length,
                missing: results.filter(r => r.status === 1).length,
                redirect: results.filter(r => r.status === 2).length,
                chain: results.filter(r => r.status === 3).length
            };

            document.getElementById('totalCount').textContent = summary.total;
            document.getElementById('okCount').textContent = summary.ok;
            document.getElementById('differentCount').textContent = summary.different;
            document.getElementById('missingCount').textContent = summary.missing;
            document.getElementById('redirectCount').textContent = summary.redirect;
            document.getElementById('chainCount').textContent = summary.chain;

            // Calculate and display percentages
            if (summary.total > 0) {
                document.getElementById('okPercent').textContent = `${Math.round((summary.ok / summary.total) * 100)}%`;
                document.getElementById('differentPercent').textContent = `${Math.round((summary.different / summary.total) * 100)}%`;
                document.getElementById('missingPercent').textContent = `${Math.round((summary.missing / summary.total) * 100)}%`;
                document.getElementById('redirectPercent').textContent = `${Math.round((summary.redirect / summary.total) * 100)}%`;
                document.getElementById('chainPercent').textContent = `${Math.round((summary.chain / summary.total) * 100)}%`;
            } else {
                document.getElementById('okPercent').textContent = '0%';
                document.getElementById('differentPercent').textContent = '0%';
                document.getElementById('missingPercent').textContent = '0%';
                document.getElementById('redirectPercent').textContent = '0%';
                document.getElementById('chainPercent').textContent = '0%';
            }
        }

        function getStatusClass(status) {
            const classes = ['status-ok', 'status-missing', 'status-redirect', 'status-chain', 'status-different'];
            return classes[status] || 'status-ok';
        }

        function addResultToTable(result) {
            const tbody = document.getElementById('tableBody');
            
            // Ensure currentFilter is never undefined - default to 'all'
            if (!currentFilter) {
                currentFilter = 'all';
            }
            
            // Check if we need to clear the loading message (only when streaming results)
            const firstRow = tbody.querySelector('tr');
            if (firstRow && firstRow.querySelector('.loading-message')) {
                tbody.innerHTML = '';
            }

            const row = document.createElement('tr');
            const statusText = statusMap[result.status];
            row.dataset.status = statusText;
            row.dataset.pageUrl = result.existingPageUrl;
            row.dataset.lastModified = result.lastModified || '';
            
            const statusClass = getStatusClass(result.status);
            
            const titleComparison = result.titleComparison || '';
            const ogTitleComparison = result.ogTitleComparison || '';
            const lastModified = result.lastModifiedFormatted || '';
            const checkedAt = result.checkedAtFormatted || '';
            
            row.innerHTML = `
                <td><a href="${result.existingPageUrl}" target="_blank">${result.existingPage}</a></td>
                <td>${result.newPageUrl ? `<a href="${result.newPageUrl}" target="_blank">${result.newPage}</a>` : result.newPage}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td><span class="comparison-badge comparison-${titleComparison.toLowerCase()}">${titleComparison}</span></td>
                <td><span class="comparison-badge comparison-${ogTitleComparison.toLowerCase()}">${ogTitleComparison}</span></td>
                <td>${lastModified}</td>
                <td>${checkedAt}</td>
                <td><button class="refresh-btn" onclick="refreshSinglePage(this)">↻ Refresh</button></td>
            `;
            
            // Don't hide any rows - let filterTable handle visibility
            tbody.appendChild(row);
        }

        function filterTable() {
            // Handle undefined filter (treat as 'all')
            const activeFilter = currentFilter || 'all';
            const rows = document.querySelectorAll('#tableBody tr');
            const searchLower = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                // Check filter match
                const statusMatch = activeFilter === 'all' || row.dataset.status === activeFilter;
                
                // Check search match (search in both existing and new page URLs)
                let searchMatch = true;
                if (searchLower) {
                    const existingUrl = row.dataset.pageUrl?.toLowerCase() || '';
                    const cells = row.querySelectorAll('td');
                    const newUrl = cells[1]?.textContent?.toLowerCase() || '';
                    searchMatch = existingUrl.includes(searchLower) || newUrl.includes(searchLower);
                }
                
                // Show row only if both filter and search match
                if (statusMatch && searchMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    filterTable();
                });
            });

            document.querySelectorAll('.summary-card').forEach(card => {
                card.addEventListener('click', () => {
                    const filter = card.dataset.filter;
                    document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    const filterBtn = document.querySelector(`.filter-btn[data-filter="${filter}"]`);
                    if (filterBtn) {
                        filterBtn.classList.add('active');
                        currentFilter = filter;
                        filterTable();
                    }
                });
            });
        }

        async function startChecking(useCache = true) {
            // Clear existing results
            results.length = 0;
            currentFilter = 'all'; // Reset filter to 'all'
            
            document.getElementById('tableBody').innerHTML = `
                <tr>
                    <td colspan="8" class="loading-message">
                        <span class="spinner"></span>
                        ${useCache ? 'Loading from cache or checking pages...' : 'Checking all pages...'}
                    </td>
                </tr>
            `;
            
            const url = `/api/sitemap/check?useCache=${useCache}`;
            const eventSource = new EventSource(url);
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.error) {
                        console.error('Error:', data.error);
                        document.getElementById('progressText').innerHTML = `<span style="color: #FA1500;">Error: ${data.error}</span>`;
                        return;
                    }
                    
                    const progressBar = document.getElementById('progressBar');
                    const progressBarText = document.getElementById('progressBarText');
                    
                    // Handle initial loading phase (counting pages)
                    if (data.totalPages === -1) {
                        progressBar.style.width = '10%';
                        progressBarText.textContent = 'Loading...';
                        progressBarText.className = 'progress-bar-text';
                        document.getElementById('progressText').innerHTML = 
                            `<span class="spinner"></span>Checking root pages... (${data.processedPages} checked)`;
                    } 
                    else if (!data.totalPages || data.totalPages === 0) {
                        progressBar.style.width = '0%';
                        progressBarText.textContent = '0%';
                        progressBarText.className = 'progress-bar-text';
                        document.getElementById('progressText').innerHTML = 
                            `<span class="spinner"></span>Initializing...`;
                    }
                    else {
                        const progress = Math.round((data.processedPages / data.totalPages) * 100);
                        const remaining = data.totalPages - data.processedPages;
                        progressBar.style.width = progress + '%';
                        progressBarText.textContent = progress + '%';
                        
                        // Change text color based on progress
                        if (progress > 50) {
                            progressBarText.className = 'progress-bar-text light';
                        } else {
                            progressBarText.className = 'progress-bar-text';
                        }
                        
                        document.getElementById('progressText').innerHTML = 
                            `<span class="spinner"></span>Checking page ${data.processedPages} of ${data.totalPages} (<strong>${remaining} remaining</strong>)`;
                    }
                    
                if (data.currentResult) {
                    results.push(data.currentResult);
                    addResultToTable(data.currentResult);
                    updateSummary();
                }
                    
                    if (data.isComplete) {
                        eventSource.close();
                        progressBar.style.width = '100%';
                        progressBarText.textContent = '100%';
                        progressBarText.className = 'progress-bar-text light';
                        document.getElementById('progressText').innerHTML = 
                            `✓ Complete! Processed ${data.processedPages} pages.`;
                        document.getElementById('progressContainer').style.background = '#E8F9F0';
                        document.getElementById('filters').classList.remove('hidden');
                        checkCacheStatus();
                    }
                } catch (error) {
                    console.error('Error parsing data:', error);
                }
            };
            
            eventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                
                // Don't close immediately - check if we're still getting data
                if (eventSource.readyState === EventSource.CLOSED) {
                    eventSource.close();
                    
                    // Only show error if we haven't received any results yet
                    if (results.length === 0) {
                        document.getElementById('progressText').innerHTML = 
                            '<span style="color: #FA1500;">Error connecting to server. Please refresh the page.</span>';
                    } else {
                        document.getElementById('progressText').innerHTML = 
                            `<span style="color: #FFA100;">⚠ Connection lost. Showing ${results.length} results from cache.</span>`;
                        document.getElementById('progressContainer').style.background = '#FFF4E0';
                        document.getElementById('filters').classList.remove('hidden');
                    }
                }
            };
        }

        async function checkCacheStatus() {
            try {
                const response = await fetch('/api/sitemap/cached');
                const data = await response.json();
                if (data.cached) {
                    const cacheDate = new Date(data.cachedAt);
                    document.getElementById('cacheInfo').textContent = 
                        `Cached: ${cacheDate.toLocaleString()}`;
                } else {
                    document.getElementById('cacheInfo').textContent = '';
                }
            } catch (error) {
                console.error('Error checking cache status:', error);
            }
        }

        async function clearCache() {
            if (!confirm('Are you sure you want to clear the cache?')) {
                return;
            }

            try {
                await fetch('/api/sitemap/clear-cache', { method: 'POST' });
                
                // Reset all UI state
                results.length = 0;
                currentFilter = 'all';
                searchTerm = '';
                
                // Clear cache info display
                document.getElementById('cacheInfo').textContent = '';
                
                // Reset filters section
                document.getElementById('filters').classList.add('hidden');
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.filter-btn[data-filter="all"]')?.classList.add('active');
                document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('active'));
                
                // Clear search input
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = '';
                }
                
                // Reset progress container
                document.getElementById('progressContainer').style.background = '#fff';
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressBarText').textContent = '0%';
                document.getElementById('progressBarText').className = 'progress-bar-text';
                document.getElementById('progressText').innerHTML = '✓ Cache cleared. Click "Refresh All" to check pages.';
                
                // Clear summary cards
                updateSummary();
                
                // Clear table and show message
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="loading-message">
                            Cache cleared. Click "Refresh All" or "+ Find New Pages" to start checking.
                        </td>
                    </tr>
                `;
            } catch (error) {
                console.error('Error clearing cache:', error);
                alert('Error clearing cache. Please try again.');
            }
        }

        async function startCheckingNewPages() {
            // Don't clear results array or table - we'll append new ones
            // Just update the progress indicator
            // Make sure filter is set to 'all' to show new pages
            if (!currentFilter) currentFilter = 'all';
            
            document.getElementById('progressText').innerHTML = 
                `<span class="spinner"></span>Discovering new pages from sitemap...`;
            
            const url = `/api/sitemap/check-new`;
            const eventSource = new EventSource(url);
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    if (data.error) {
                        console.error('Error:', data.error);
                        document.getElementById('progressText').innerHTML = `<span style="color: #FA1500;">Error: ${data.error}</span>`;
                        return;
                    }
                    
                    const progressBar = document.getElementById('progressBar');
                    const progressBarText = document.getElementById('progressBarText');
                    
                    if (data.totalPages === -1) {
                        progressBar.style.width = '10%';
                        progressBarText.textContent = 'Loading...';
                        progressBarText.className = 'progress-bar-text';
                        document.getElementById('progressText').innerHTML = 
                            `<span class="spinner"></span>Fetching new site sitemap...`;
                    } 
                    else if (!data.totalPages || data.totalPages === 0) {
                        progressBar.style.width = '0%';
                        progressBarText.textContent = '0%';
                        progressBarText.className = 'progress-bar-text';
                        document.getElementById('progressText').innerHTML = 
                            `<span class="spinner"></span>Initializing...`;
                    }
                    else {
                        const progress = Math.round((data.processedPages / data.totalPages) * 100);
                        const remaining = data.totalPages - data.processedPages;
                        progressBar.style.width = progress + '%';
                        progressBarText.textContent = progress + '%';
                        
                        if (progress > 50) {
                            progressBarText.className = 'progress-bar-text light';
                        } else {
                            progressBarText.className = 'progress-bar-text';
                        }
                        
                        document.getElementById('progressText').innerHTML = 
                            `<span class="spinner"></span>Checking page ${data.processedPages} of ${data.totalPages} (<strong>${remaining} remaining</strong>)`;
                    }
                    
                    if (data.currentResult) {
                        // Check if this result already exists (by existing page URL) to avoid duplicates
                        const existingIndex = results.findIndex(r => r.existingPageUrl === data.currentResult.existingPageUrl);
                        if (existingIndex === -1) {
                            // New result - add it
                            results.push(data.currentResult);
                            addResultToTable(data.currentResult);
                            updateSummary();
                        }
                    }
                    
                    if (data.isComplete) {
                        eventSource.close();
                        progressBar.style.width = '100%';
                        progressBarText.textContent = '100%';
                        progressBarText.className = 'progress-bar-text light';
                        
                        document.getElementById('progressText').innerHTML = 
                            `✓ Complete! Total pages: ${results.length}`;
                        document.getElementById('progressContainer').style.background = '#E8F9F0';
                        document.getElementById('filters').classList.remove('hidden');
                        checkCacheStatus();
                    }
                } catch (error) {
                    console.error('Error parsing data:', error);
                }
            };
            
            eventSource.onerror = (error) => {
                console.error('EventSource error:', error);
                
                if (eventSource.readyState === EventSource.CLOSED) {
                    eventSource.close();
                    
                    if (results.length === 0) {
                        document.getElementById('progressText').innerHTML = 
                            '<span style="color: #FA1500;">Error connecting to server. Please refresh the page.</span>';
                    } else {
                        document.getElementById('progressText').innerHTML = 
                            `<span style="color: #FFA100;">⚠ Connection lost. Showing ${results.length} results.</span>`;
                        document.getElementById('progressContainer').style.background = '#FFF4E0';
                        document.getElementById('filters').classList.remove('hidden');
                    }
                }
            };
        }

        async function refreshSinglePage(button) {
            const row = button.closest('tr');
            const pageUrl = row.dataset.pageUrl;
            const lastModified = row.dataset.lastModified ? new Date(row.dataset.lastModified) : null;
            
            button.disabled = true;
            button.classList.add('refreshing');
            button.textContent = '⋯ Checking...';
            
            try {
                const response = await fetch('/api/sitemap/check-single', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pageUrl: pageUrl,
                        lastModified: lastModified
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to refresh page');
                }
                
                const result = await response.json();
                
                // Update the row with new data
                const statusText = statusMap[result.status];
                const statusClass = getStatusClass(result.status);
                const titleComparison = result.titleComparison || '';
                const ogTitleComparison = result.ogTitleComparison || '';
                const lastModifiedFormatted = result.lastModifiedFormatted || '';
                const checkedAtFormatted = result.checkedAtFormatted || '';
                
                // Update dataset attributes
                row.dataset.status = statusText;
                row.dataset.pageUrl = result.existingPageUrl;
                row.dataset.lastModified = result.lastModified || '';
                
                row.innerHTML = `
                    <td><a href="${result.existingPageUrl}" target="_blank">${result.existingPage}</a></td>
                    <td>${result.newPageUrl ? `<a href="${result.newPageUrl}" target="_blank">${result.newPage}</a>` : result.newPage}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><span class="comparison-badge comparison-${titleComparison.toLowerCase()}">${titleComparison}</span></td>
                    <td><span class="comparison-badge comparison-${ogTitleComparison.toLowerCase()}">${ogTitleComparison}</span></td>
                    <td>${lastModifiedFormatted}</td>
                    <td>${checkedAtFormatted}</td>
                    <td><button class="refresh-btn" onclick="refreshSinglePage(this)">↻ Refresh</button></td>
                `;
                
                // Update the result in our local array
                const index = results.findIndex(r => r.existingPageUrl === pageUrl);
                if (index >= 0) {
                    results[index] = result;
                    updateSummary();
                    filterTable();
                }
                
            } catch (error) {
                console.error('Error refreshing page:', error);
                alert('Error refreshing page. Please try again.');
                button.disabled = false;
                button.classList.remove('refreshing');
                button.textContent = '↻ Refresh';
            }
        }

        // Sorting functionality
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        function setupSorting() {
            document.querySelectorAll('th.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.column;
                    sortTable(column);
                    
                    // Update header styles
                    document.querySelectorAll('th.sortable').forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });
                    
                    if (currentSortColumn === column) {
                        header.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            });
        }

        function sortTable(column) {
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            results.sort((a, b) => {
                let valueA, valueB;

                switch (column) {
                    case 'existingPage':
                        valueA = a.existingPage.toLowerCase();
                        valueB = b.existingPage.toLowerCase();
                        break;
                    case 'newPage':
                        valueA = a.newPage.toLowerCase();
                        valueB = b.newPage.toLowerCase();
                        break;
                    case 'status':
                        valueA = a.status;
                        valueB = b.status;
                        break;
                    case 'titleComparison':
                        valueA = a.titleComparison || '';
                        valueB = b.titleComparison || '';
                        break;
                    case 'ogTitleComparison':
                        valueA = a.ogTitleComparison || '';
                        valueB = b.ogTitleComparison || '';
                        break;
                    case 'lastModified':
                        valueA = a.lastModified ? new Date(a.lastModified).getTime() : 0;
                        valueB = b.lastModified ? new Date(b.lastModified).getTime() : 0;
                        break;
                    case 'checkedAt':
                        valueA = new Date(a.checkedAt).getTime();
                        valueB = new Date(b.checkedAt).getTime();
                        break;
                    default:
                        return 0;
                }

                if (valueA < valueB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Re-render table
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            results.forEach(result => addResultToTable(result));
            filterTable();
        }

        // CSV Export functionality
        function exportToCSV() {
            if (results.length === 0) {
                alert('No data to export!');
                return;
            }

            // Prepare CSV content
            const headers = ['Existing Page', 'Existing URL', 'New Page', 'New URL', 'Status', 'Title Comparison', 'og:title Comparison', 'Original Last Modified', 'Checked At'];
            const csvRows = [headers.join(',')];

            // Filter results based on current filter
            const filteredResults = currentFilter === 'all' 
                ? results 
                : results.filter(r => statusMap[r.status] === currentFilter);

            filteredResults.forEach(result => {
                const row = [
                    escapeCsvField(result.existingPage),
                    escapeCsvField(result.existingPageUrl),
                    escapeCsvField(result.newPage),
                    escapeCsvField(result.newPageUrl || ''),
                    escapeCsvField(statusMap[result.status]),
                    escapeCsvField(result.titleComparison || ''),
                    escapeCsvField(result.ogTitleComparison || ''),
                    escapeCsvField(result.lastModifiedFormatted || ''),
                    escapeCsvField(result.checkedAtFormatted || '')
                ];
                csvRows.push(row.join(','));
            });

            // Create blob and download
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `sitemap-check-results-${timestamp}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Helper function to properly escape CSV fields
        function escapeCsvField(field) {
            // Convert to string and handle null/undefined
            const value = String(field || '');
            // If field contains comma, quote, or newline, wrap in quotes and escape internal quotes
            if (value.includes(',') || value.includes('"') || value.includes('\n') || value.includes('\r')) {
                return `"${value.replace(/"/g, '""')}"`;
            }
            // Always quote to ensure consistency
            return `"${value}"`;
        }

        // Load initial data from cache or show empty state
        async function loadInitialData() {
            try {
                const response = await fetch('/api/sitemap/cached');
                const data = await response.json();
                
                if (data.cached && data.results && data.results.length > 0) {
                    // Clear results array and table
                    results.length = 0;
                    document.getElementById('tableBody').innerHTML = '';
                    
                    // Load results into array
                    data.results.forEach(result => {
                        results.push(result);
                        addResultToTable(result);
                    });
                    
                    // Update summary
                    updateSummary();
                    
                    // Show filters
                    document.getElementById('filters').classList.remove('hidden');
                    
                    // Update progress to show cache loaded
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressBarText').textContent = '100%';
                    document.getElementById('progressBarText').className = 'progress-bar-text light';
                    document.getElementById('progressText').innerHTML = 
                        `✓ Loaded ${results.length} pages from cache`;
                    document.getElementById('progressContainer').style.background = '#E8F9F0';
                } else {
                    // No cache - show message
                    document.getElementById('progressBar').style.width = '0%';
                    document.getElementById('progressBarText').textContent = '0%';
                    document.getElementById('progressText').innerHTML = 
                        'No data yet. Click "Refresh All" to check all pages.';
                    document.getElementById('tableBody').innerHTML = `
                        <tr>
                            <td colspan="8" class="loading-message">
                                No data available. Click "Refresh All" or "+ Find New Pages" to start.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading initial data:', error);
                document.getElementById('progressText').innerHTML = 
                    'Error loading data. Please click "Refresh All".';
            }
        }

        // Setup event listeners
        document.getElementById('refreshBtn').addEventListener('click', () => {
            startChecking(false);
        });

        document.getElementById('checkNewBtn').addEventListener('click', () => {
            startCheckingNewPages();
        });

        document.getElementById('clearCacheBtn').addEventListener('click', clearCache);
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value;
            filterTable();
        });

        // Focus search input on Ctrl+F or Cmd+F
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                searchInput.focus();
            }
        });

        // Clear search button
        document.getElementById('clearSearchBtn').addEventListener('click', () => {
            searchInput.value = '';
            searchTerm = '';
            filterTable();
        });

        // Add focus/blur styling for search input
        searchInput.addEventListener('focus', () => {
            searchInput.style.borderColor = '#370088';
        });
        searchInput.addEventListener('blur', () => {
            searchInput.style.borderColor = '#ddd';
        });

        setupFilters();
        setupSorting();
        checkCacheStatus();
        
        // Try to load from cache if available, otherwise show empty state
        loadInitialData();
    </script>
</body>
</html>
